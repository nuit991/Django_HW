<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>分頁顯示</title>
    <style>
        .product-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 20px;
        }
        .product-item {
            width: 19%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            text-align: center;
        }
        .product-item img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }
        .product-item h3, .product-item p {
            margin: 10px 0;
        }
        .product-item a {
            display: inline-block;
            padding: 5px 10px;
            background-color: #007bff;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
        }
        .product-item a:hover {
            background-color: #0056b3;
        }
        #total-items {
            margin-top: 20px;
            font-size: 1.5em;
        }
        .button-container {
            display: flex;
            gap: 10px;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        button {
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <h1>分頁顯示</h1>
    <div class="button-container">
        <div class="button-group">
            <button data-target="momo">Momo商品结果</button>
            <button data-target="momo" data-action="clear">清除Momo结果</button>
        </div>
        <div class="button-group">
            <button data-target="pchome">PChome商品结果</button>
            <button data-target="pchome" data-action="clear">清除PChome结果</button>
        </div>
        <div class="button-group">
            <button data-target="yahoo">Yahoo商品结果</button>
            <button data-target="yahoo" data-action="clear">清除Yahoo结果</button>
        </div>
    </div>

    <div id="momo-product-container" class="product-row" style="display: none;"></div>
    <div id="momo-total-items" style="display: none;">共 0 件商品</div>

    <div id="pchome-product-container" class="product-row" style="display: none;"></div>
    <div id="pchome-total-items" style="display: none;">共 0 件商品</div>

    <div id="yahoo-product-container" class="product-row" style="display: none;"></div>
    <div id="yahoo-total-items" style="display: none;">共 0 件商品</div>

    <script>
        

        const socketMomo = initializeWebSocket('momo', productNameMomo, maxPagesMomo);
        const socketPchome = initializeWebSocket('pchome', productNamePchome, maxPagesPchome);
        const socketYahoo = initializeWebSocket('yahoo', productNameYahoo, maxPagesYahoo);

        function initializeWebSocket(target, productName, maxPages) {
            const socket = new WebSocket('ws://' + window.location.host.replace(':8000', ':9000') + '/ws/${target}/');
            socket.onopen = () => {
                console.log(`WebSocket connection opened for ${target}`);
                socket.send(JSON.stringify({
                    command: 'start',
                    [`${target}_product_name`]: productName,
                    [`${target}_max_pages`]: maxPages
                }));
            };
            socket.onmessage = event => {
                const data = JSON.parse(event.data);
                if (data.status === 'completed') {
                    console.log(`Data fetch completed for ${target}`);
                    socket.close();
                } else {
                    const productContainer = document.getElementById(`${target}-product-container`);
                    const productItem = document.createElement('div');
                    productItem.className = 'product-item';
                    productItem.innerHTML = `
                        <h3>${data.prd_name}</h3>
                        <p>價格：${data.price}</p>
                        <img src="${data.img_url}" alt="Product Image" width="200" height="200" onerror="this.onerror=null;this.src='default.jpg';">
                        <a href="${data.product_url}" target="_blank">查看商品</a>
                    `;
                    productContainer.appendChild(productItem);
                    const totalItemsElement = document.getElementById(`${target}-total-items`);
                    const currentCount = parseInt(totalItemsElement.textContent.match(/\d+/)) || 0;
                    totalItemsElement.textContent = `共 ${currentCount + 1} 件商品`;
                }
            };
            socket.onerror = error => console.error(`WebSocket Error for ${target}:`, error);
            socket.onclose = event => {
                console.log(`WebSocket closed for ${target}`);
                alert(`WebSocket connection closed for ${target}`);
            };
            return socket;
        }

        

        function toggleDisplay(target, show) {
            document.getElementById(`${target}-product-container`).style.display = show ? 'flex' : 'none';
            document.getElementById(`${target}-total-items`).style.display = show ? 'block' : 'none';
        }

        function clearResults(target) {
            document.getElementById(`${target}-product-container`).innerHTML = '';
            document.getElementById(`${target}-total-items`).textContent = '共 0 件商品';
        }

        document.querySelectorAll('.button-container button').forEach(button => {
            button.addEventListener('click', () => {
                const target = button.getAttribute('data-target');
                if (button.getAttribute('data-action') === 'clear') {
                    clearResults(target);
                    toggleDisplay(target, false);
                } else {
                    toggleDisplay(target, true);
                }
            });
        });
    </script>
</body>
</html>
